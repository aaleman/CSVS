<link rel="import" href="../lib/jsorolla/src/lib/components/jso-genome-viewer-element.html">
<link rel="import" href="../lib/jsorolla/src/lib/components/variant/jso-variant-effect-grid.html">
<link rel="import" href="../lib/jsorolla/src/lib/components/variant/jso-variant-frequencies-grid.html">
<link rel="import" href="../lib/jsorolla/src/lib/components/variant/jso-variant-phenotype-grid.html">

<link rel="import" href="../lib/jsorolla/src/lib/components/table/jso-table.html">

<dom-module id="pvs-search-element">
    <style>
        :host {
            display: block;
            box-sizing: border-box;
            position: relative;
            background-color: var(--text-primary-color);
            color: var(--primary-text-color);
        }

        #filter-form-element {
            background-color: #FFFFFF;
            width: 350px;
            margin: 20px;
            min-height: 900px;
        }

        textarea {
            resize: none;
        }

        .searchGene {
            margin-top: 5px;
        }

        #dataGridElement {
            border-radius: 0px !important;
            margin: 20px 20px 20px 0px;
            background-color: #FFFFFF;
            width:calc(100% - 290px);
        }

        .container > span {
            margin-left: 10px;
        }

        #diseases_div {
            height: 300px;
            max-height: 300px;
            overflow-y: auto;
        }

        #exportBtn {
            height: 20px;
        }

        #dataTable {
            font-size: 11px;
        }

        jso-table {
            overflow-y: auto;

        }

        jso-table::shadow .table-header-field > .name.jso-table {
            padding: 4px 0;
        }

        jso-table::shadow #list {
            height: 300px;
            overflow-x: auto
        }

        #menu {
            /*border-bottom: 1px solid rgba(125, 125, 125, 0.4);*/
            margin-top: 15px;
        }

        #menu > div {
            font-size: 17px;
            padding: 5px 5px;
            margin: 0 20px;
            border-bottom: 2px solid transparent;
            transition: all 0.1s;
            cursor: pointer;
        }

        #menu > div:hover {
            border-bottom-color: rgba(125, 125, 125, 0.4);
        }

        #menu > div[selected] {
            border-bottom-color: rgba(125, 125, 125, 0.7);
        }

        #tools {
            /*height: calc(100% - 375px);*/
            /*overflow-x: hidden;*/

            margin-top: 10px;
        }

        jso-variant-frequencies-grid,
        jso-variant-effect-grid,
        jso-variant-grid,
        jso-genome-viewer-element,
        .jso-formbox,
        #dataTable {
            box-shadow: 0px 0px 2px 0px rgba(0, 0, 0, 0.2);
        }

        jso-variant-frequencies-grid,
        jso-variant-effect-grid,
        #dataTable {
            border: 1px solid var(--divider-color)
        }

        .check {
            cursor: pointer;
            color: var(--secondary-text-color);
        }

        .check:hover {
            color: var(--accent-color);
        }
    </style>
    <template>
        <div class="horizontal layout">
            <div id="filter-form-element">
                <form id="filter_form" class="vertical layout">
                    <div vertical layout>
                        <div id="buttons_container" class="horizontal layout end-justified" style="margin:10px 5px;">
                            <div class="jso-btn jso-btn-shdw flex" on-click="clearForm" style="margin-right: 3px;">
                                Clear
                            </div>
                            <div class="jso-btn jso-btn-shdw flex" on-click="submitForm">Search</div>
                        </div>
                        <div class="form_block positionBlock">

                            <div class="jso-formbox">
                                <div class="jso-formtitle">
                                    Position
                                </div>
                                <div class="jso-formcontent">
                                    <div class="input_container vertical layout">
                                        <label class="jso">Chromosomal Location:</label>
                                        <textarea id="region" name="region" placeholder="1:1-100000,2:1-100000"
                                                  value="{{regionValue::change}}" rows="3"></textarea>
                                    </div>
                                    <div class="input_container vertical layout">
                                        <label class="jso">Gene:</label>
                                        <textarea id="gene" name="gene" placeholder="BRCA2,PPL"
                                                  value="{{geneValue::change}}" rows="3"></textarea>

                                        <div class="searchGene horizontal layout end-justified" hidden>
                                            <input id="searchField" list="searchDataList" placeholder="Search gene"
                                                   type="text"
                                                   style="width: 100px;">
                                            <datalist id="searchDataList"></datalist>
                                            <div id="quickSearchButton" class="button" style="border-left: none;">
                                                <font-awesome icon="search"></font-awesome>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>

                        </div>


                        <div class="jso-formbox">
                            <div class="jso-formtitle horizontal layout center">
                                <div>Diseases</div>
                                <div class="flex"></div>
                                <div class="check" on-click="selectAllDiseases">
                                    <i class="fa fa-check"></i>
                                </div>
                                <div class="check" on-click="deselectAllDiseases">
                                    <i class="fa fa-times"></i>
                                </div>

                                <!--<paper-button on-click="{{ selectAllDiseases }}">All</paper-button>-->
                                <!--<paper-button on-click="{{ deselectAllDiseases }}">None</paper-button>-->

                            </div>
                            <div id="diseases_div" class="jso-formcontent" style="padding: 8px 10px">
                                <template is="dom-repeat" items="{{diseases}}">
                                    <label class="jso-control">
                                        <input type="checkbox" class="diseaseName" name="disease" id="disease"
                                               value="{{item.groupId}}" checked/>
                                        <span>{{item.name}}</span>
                                    </label>
                                </template>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div id="dataGridElement" class="vertical layout">
                <jso-table id="dataTable" enable-paging enable-remote enable-select request="{{request}}"
                           columns="{{columns}}" on-rowclick="handleRowClick">
                </jso-table>

                <div id="menu" class="color-2 color-hover-2 horizontal layout">
                    <div on-click="handleMenuClick" data-option="gv">Genomic context</div>
                    <div on-click="handleMenuClick" data-option="frequency">Frequencies</div>
                    <div on-click="handleMenuClick" data-option="phenotype">Phenotype</div>
                    <div on-click="handleMenuClick" data-option="effect">Effect</div>
                </div>

                <!--<paper-button raised on-click="{{ exportQueryToCSV }}" horizontal layout end-justified-->
                <!--id="exportBtn">Export to CSV-->
                <!--</paper-button>-->

                <div id="tools">
                    <jso-genome-viewer-element id="gv" hidden></jso-genome-viewer-element>
                    <jso-variant-frequencies-grid id="frequency" hidden></jso-variant-frequencies-grid>
                    <jso-variant-phenotype-grid id="phenotype" hidden></jso-variant-phenotype-grid>
                    <jso-variant-effect-grid id="effect" hidden></jso-variant-effect-grid>
                </div>
            </div>
        </div>
    </template>
</dom-module>
<script>
    Polymer({
        is: 'pvs-search-element',
        properties: {
            diseases: {
                type: Array,
                value: function () {
                    return [];
                }
            },
            regionValue: {
                type: String,
                value: ""
            },
            columns: {
                type: Array,
                value: function () {
                    return [];
                }
            },
            formURL: {
                type: String,
                value: "",
                observer: 'urlChanged'
            },
            floatDecimals: {
                type: Number,
                value: 3
            },

            selectedMenuTool: {
                type: Object,
                observer: 'selectedMenuChanged'
            },
            geneValue: {
                type: String,
                value: ""
            },
            hidden: {
                type: Boolean,
                reflectToAttribute: true,
                observer: 'hiddenChanged',
                nofity: true
            }
        },
        hiddenChanged: function (neo, old) {

            if (!neo && this.selectedMenuTool) {
                this.$.gv.removeAttribute("hidden");
            }
        },
        created: function () {
            this.selectedSpecies = DEFAULT_SPECIES;
        },
        ready: function () {
            var me = this;
            this.species = 'Homo sapiens';
            var lastQuery = '';

            this.async(function () { // DOM READY
                me.selectedMenuTool = me.$.menu.querySelector('div');
            }, 50);


            this.$.searchField.addEventListener('keyup', function (event) {
                this.classList.remove('error');
                var query = this.value.toUpperCase();
                if (query.length > 2 && lastQuery !== query && event.which !== 13) {
                    me._setQuickSearchMenu(query);
                    lastQuery = query;
                }

                if (event.which === 13) {
                    var item = me.quickSearchDataset[query];
                    if (item) {
                        var values = me.$.gene.value.split(',').filter(function (el) {
                            return el.length != 0
                        });

                        values.push(item.name);
                        values = values.filter(function (item, index, inputArray) {
                            return inputArray.indexOf(item) == index;
                        });

                        me.$.gene.value = values.join(",");


                    } else {
                        this.classList.add('error');
                    }
                }
            });

            this.columns = [
                {name: 'chromosome', title: "Chr", width: 40},
                {name: 'position', title: 'Position', width: 70},
                {
                    name: 'alleles',
                    title: 'Alleles',
                    width: 50,
                    formula: function (row) {
                        return row.reference + ">" + row.alternate;
                    }
                },
                // {name: 'gene', title: 'Gene'},
                {name: 'id', title: 'Id', width: 90},
                {
                    title: 'MAF',
                    name: 'maf',
                    width: 300,
                    columns: [
                        {
                            title: "Genotypes",
                            name: 'genotypes',
                            width: 150,
                            columns: [
                                {
                                    name: "gt00", width: 50, title: "0/0", formula: function (row) {
                                    if (row.stats != null && row.stats.gt00 != null)
                                        return row.stats.gt00;
                                    else
                                        return ".";
                                }
                                },
                                {
                                    name: "gt01", width: 50, title: "0/1", formula: function (row) {
                                    if (row.stats != null && row.stats.gt01 != null)
                                        return row.stats.gt01;
                                    else
                                        return ".";
                                }
                                },
                                {
                                    name: "gt11", width: 50, title: "1/1", formula: function (row) {
                                    if (row.stats != null && row.stats.gt11 != null)
                                        return row.stats.gt11;
                                    else
                                        return ".";
                                }
                                }
                            ]
                        },
                        {
                            title: "Freq.",
                            name: "freq",
                            width: 150,
                            columns: [
                                {
                                    name: "refFreq", width: 50, title: "0 Freq", formula: function (row) {
                                    if (row.stats != null && row.stats.refFreq != null)
                                        return row.stats.refFreq;
                                    else
                                        return ".";
                                }
                                },
                                {
                                    name: "altFreq", width: 50, title: "1 Freq", formula: function (row) {
                                    if (row.stats != null && row.stats.altFreq != null)
                                        return row.stats.altFreq;
                                    else
                                        return ".";
                                }
                                },
                                {
                                    name: "maf", width: 50, title: "MAF", formula: function (row) {
                                    if (row.stats != null && row.stats.maf != null)
                                        return row.stats.maf;
                                    else
                                        return ".";
                                }
                                }
                            ]
                        }
                    ]
                },
                {
                    title: "1000G MAF (phase 1)", width: 250,
                    name: 'maf1000g',
                    columns: [
                        {
                            name: "maf1000G",
                            title: "ALL",
                            defaultValue: ".",
                            formula: function (row) {
                                if (row.maf1000G != null) {
                                    return row.maf1000G;
                                } else {
                                    return ".";
                                }
                            }
                        },
                        {
                            name: "maf1000GAME",
                            title: "AME",
                            defaultValue: ".",
                            formula: function (row) {
                                if (row.maf1000GAME != null) {
                                    return row.maf1000GAME;
                                } else {
                                    return ".";
                                }
                            }
                        },
                        {
                            name: "maf1000GASI",
                            title: "ASI",
                            defaultValue: ".",
                            formula: function (row) {
                                if (row.maf1000GASI != null) {
                                    return row.maf1000GASI;
                                } else {
                                    return ".";
                                }
                            }
                        },
                        {
                            name: "maf1000GAFR",
                            title: "AFR",
                            defaultValue: ".",
                            formula: function (row) {
                                if (row.maf1000GAFR != null) {
                                    return row.maf1000GAFR;
                                } else {
                                    return ".";
                                }
                            }
                        },
                        {
                            name: "maf1000GEUR",
                            title: "EUR",
                            defaultValue: ".",
                            formula: function (row) {
                                if (row.maf1000GEUR != null) {
                                    return row.maf1000GEUR;
                                } else {
                                    return ".";
                                }
                            }
                        }

                    ]
                },
                {
                    title: "1000G MAF (phase 3)", width: 300,
                    name: 'maf1000G3',
                    columns: [
                        {
                            name: "maf1000G_PHASE_3_ALL",
                            title: "ALL",
                            defaultValue: ".",
                            formula: function (row) {
                                if (row.maf1000G_PHASE_3_ALL != null) {
                                    return row.maf1000G_PHASE_3_ALL;
                                } else {
                                    return ".";
                                }
                            }
                        },
                        {
                            name: "maf1000G_PHASE_3_AMR",
                            title: "AME",
                            defaultValue: ".",
                            formula: function (row) {
                                if (row.maf1000G_PHASE_3_AMR != null) {
                                    return row.maf1000G_PHASE_3_AMR;
                                } else {
                                    return ".";
                                }
                            }
                        },
                        {
                            name: "maf1000G_PHASE_3_SAS",
                            title: "South ASI",
                            defaultValue: ".",
                            formula: function (row) {
                                if (row.maf1000G_PHASE_3_SAS != null) {
                                    return row.maf1000G_PHASE_3_SAS;
                                } else {
                                    return ".";
                                }
                            }
                        },
                        {
                            name: "maf1000G_PHASE_3_EAS",
                            title: "East ASI",
                            defaultValue: ".",
                            formula: function (row) {
                                if (row.maf1000G_PHASE_3_EAS != null) {
                                    return row.maf1000G_PHASE_3_EAS;
                                } else {
                                    return ".";
                                }
                            }
                        },
                        {
                            name: "maf1000G_PHASE_3_AFR",
                            title: "AFR",
                            defaultValue: ".",
                            formula: function (row) {
                                if (row.maf1000G_PHASE_3_AFR != null) {
                                    return row.maf1000G_PHASE_3_AFR;
                                } else {
                                    return ".";
                                }
                            }
                        },
                        {
                            name: "maf1000G_PHASE_3_EUR",
                            title: "EUR",
                            defaultValue: ".",
                            formula: function (row) {
                                if (row.maf1000G_PHASE_3_EUR != null) {
                                    return row.maf1000G_PHASE_3_EUR;
                                } else {
                                    return ".";
                                }
                            }
                        },
                    ]

                },
                {
                    title: "ESP 6500", width: 100,
                    name: 'maf6500',
                    columns: [
                        {
                            name: "mafESP_EA",
                            title: "Eur. Ame.",
                            defaultValue: ".",
                            formula: function (row) {
                                if (row.mafESP_EA != null) {
                                    return row.mafESP_EA;
                                } else {
                                    return ".";
                                }
                            }
                        },
                        {
                            name: "mafESP_AA",
                            title: "Afr. Ame.",
                            defaultValue: ".",
                            formula: function (row) {
                                if (row.mafESP_AA != null) {
                                    return row.mafESP_AA;
                                } else {
                                    return ".";
                                }
                            }
                        }
                    ]
                },
                {
                    name: 'sift', title: 'SIFT', width: 50
                },
                {
                    name: 'polyphen', title: 'POLYPHEN', width: 60
                },
                {
                    name: 'phastcons', title: 'PhastCons', width: 60
                },
                {
                    name: 'phylop', title: 'phyloP', width: 50
                },
                {
                    name: 'phenotypes', title: 'Phenotypes', width: 450,
                    columns: [
                        {
                            name: 'clinvar',
                            title: 'Clinvar',
                            width: 150,
                            formula: function (row) {
                                return row.phenotypes.clinvar;
                            }
                        },
                        {
                            name: 'cosmic',
                            title: 'Cosmic',
                            width: 150,
                            formula: function (row) {
                                return row.phenotypes.cosmic;
                            }
                        },
                        {
                            name: 'gwas',
                            title: 'GWas',
                            width: 150,
                            formula: function (row) {
                                return row.phenotypes.gwas;
                            }
                        }
                    ]
                }
            ];
        },
        _toFixed: function (value, precision) {
            return Number(value).toFixed(precision);
        },
        observe: {},
        _setQuickSearchMenu: function (query) {

            while (this.$.searchDataList.firstChild) {
                this.$.searchDataList.removeChild(this.$.searchDataList.firstChild);
            }
            this.quickSearchDataset = {};
            var items = this._quickSearchResultFn(query);
            for (var i = 0; i < items.length; i++) {
                var item = items[i];
                var value = item["name"];
                this.quickSearchDataset[value] = item;
                var menuEntry = document.createElement('option');
                menuEntry.setAttribute('value', value);
                this.$.searchDataList.appendChild(menuEntry);
            }

        },
        _quickSearchResultFn: function (query) {
            var results = [];
            var speciesCode = Utils.getSpeciesCode(this.species);

            CellBaseManager.get({
                host: CELLBASE_HOST,
                version: CELLBASE_VERSION,
                species: speciesCode,
                category: 'feature',
                subCategory: 'id',
                query: query,
                resource: 'starts_with',
                params: {
                    limit: 10
                },
                async: false,
                success: function (data, textStatus, jqXHR) {
                    results = data.response[0].result;
                }
            });
            return results;
        },
        submitForm: function () {
            var me = this;
            var query = {};

            if (this.$.filter_form.checkValidity() && (this.regionValue != '' || this.geneValue != '')) {

                var regions = [];

                if (this.regionValue) {
                    regions = this.regionValue.split(",");
                }

                if (this.geneValue) {
                    var gene = this.geneValue.toUpperCase();
                    CellBaseManager.get({
                        species: 'hsapiens',
                        category: 'feature',
                        subCategory: 'gene',
                        query: gene,
                        resource: "info",
                        async: false,
                        params: {
                            include: 'chromosome,start,end'
                        },
                        success: function (data) {
                            for (var i = 0; i < data.response.length; i++) {
                                var queryResult = data.response[i];

                                if (queryResult.result.length > 0) {
                                    var region = new Region(queryResult.result[0]);
                                    regions.push(region.toString());

                                } else {
                                    alert("Wrong gene: " + gene);
                                }
                            }
                        }
                    });
                }

                var diseaseEls = this.$.diseases_div.querySelectorAll(".diseaseName");
                var diseaseIds = [];


                for (var i = 0; i < diseaseEls.length; i++) {
                    var el = diseaseEls[i];
                    if (el.checked) {
                        diseaseIds.push(el.getAttribute("value"));
                    }
                }

                if (regions.length > 0) {
                    var regionQuery = regions.join(",");
                    query.regions = regionQuery;
                    query.diseases = diseaseIds.join(",");

                    var url = PVSManager.variants.fetch({
                        query: query,
                        request: {
                            url: true
                        }
                    });
                    console.log(url);

                    this.formURL = url;
                }
            } else {
                alert("Please add a region/gene and check any disease");
            }

        },
        _formatText: function (text) {
            return Utils.formatText(text, "_").toLowerCase().replace(/(?:^|\s)\S/g, function (a) {
                return a.toUpperCase();
            });
        },
        clearForm: function () {

            this.$.filter_form.reset();

        },
        exportQueryToCSV: function () {
            var numVariants = this.$.dataGrid.dataSize;

            if (numVariants > 200) {
                alert("Sorry, you are trying to export a CSV with more than 200 Variants. Please restrict your query, the maximum allowed variants are 200.");
                return;
            }

            var me = this;
            if (this.formUrl != "") {
                var url = this.formURL + "&csv=true";

                $.ajax({
                    url: url,
                    dataType: 'json',
                    async: false,
                    success: function (response, textStatus, jqXHR) {
                        if (response != undefined && response.result.length > 0) {

                            var data = response.result; // TODO aaleman: Fix this!

                            // var finalData = me.parseFunction(data);

                            // Create CSV

                            var csvData = [['chromosome', 'position', 'ref', 'alt', 'snpId', 'MAF', '1000G MAF', 'EVS MAF'].join(";")];

                            for (var i = 0; i < finalData.length; i++) {
                                var row = finalData[i];
                                var maf1000G = '.';
                                var mafEVS = '.';
                                if (row.maf1000G) {
                                    maf1000G = row.maf1000G;
                                }
                                if (row.mafEVS) {
                                    mafEVS = row.mafEVS;
                                }

                                csvData.push([
                                    row.chromosome,
                                    row.position,
                                    row.reference,
                                    row.alternate,
                                    row.id,
                                    row.stats.maf,
                                    maf1000G,
                                    mafEVS

                                ].join(";"))
                            }

                            var csvString = csvData.join("%0A");

                            var a = document.createElement('a');
                            a.href = 'data:text/csv,' + csvString;
                            a.target = '_blank';
                            a.download = 'variants.csv';

                            a.click();
                        }

                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.log('Error exporting to CSV');
                    }
                });
            }
        },
        selectAllDiseases: function (e, d, s) {
            var checkboxes = this.$.filter_form.getElementsByClassName("diseaseName");
            for (var i = 0; i < checkboxes.length; i++) {
                var elem = checkboxes[i];
                elem.checked = true;
            }

        },
        deselectAllDiseases: function (e, d, s) {
            var checkboxes = this.$.filter_form.getElementsByClassName("diseaseName");
            for (var i = 0; i < checkboxes.length; i++) {
                var elem = checkboxes[i];
                elem.checked = false;
            }
        }, urlChanged: function (neo, old) {
            var me = this;
            if (neo != '') {
                this.request = {
                    url: this.formURL,
                    parse: this._parse,
                    parseTotal: this._parseTotal,
                    file: this.file
                };

            }
        },
        _parse: function (response) {

            var me = this;

            var data = response.result;
            var positions = [];
            for (var i = 0; i < data.length; i++) {
                var row = data[i];

                var variant = row.chromosome + ":" + row.position + ":" + row.reference + ":" + row.alternate;
                positions.push(variant);

            }

            // Annotate
            var query = positions.join(",");
            if (positions.length > 0) {

                CellBaseManager.get({
                    host: CELLBASE_HOST,
                    version: CELLBASE_VERSION,
                    species: 'hsapiens',
                    category: 'genomic',
                    subCategory: 'variant',
                    resource: 'full_annotation',
                    query: query,
                    async: false,
                    success: function (response) {
                        try {
                            var annotData = response.response;
                            for (var i = 0; i < annotData.length; i++) {
                                var obj = annotData[i];
                                if (obj.result.length > 0) {
                                    var annots = obj.result[0];
                                    data[i].annots = annots;
                                }
                            }
                        } catch (e) {
                        }
                    }
                });
            }

            console.log(data);

            for (var i = 0; i < data.length; i++) {
                var variant = data[i];

                if (variant.annots == null) {
                    contine
                }

                // Annotate SNPid
                if (variant.annots.id != null && variant.annots.id) {
                    variant.id = variant.annots.id;
                }

                // Annotate Cons
                if (variant.annots.conservationScores != null && variant.annots.conservationScores.length > 0) {

                    for (var j = 0, l = variant.annots.conservationScores.length; j < l; j++) {
                        var crs = variant.annots.conservationScores[j];
                        if (crs) {
                            score = crs.score.toFixed(3)
                            switch (crs.source) {
                                case 'phastCons':
                                    variant.phastcons = score;
                                    break;
                                case 'phylop':
                                    variant.phylop = score;
                                    break;
                                default:
                            }
                        }
                    }
                }

                // Annotate CT && Subs. Score
                if (variant.annots.consequenceTypes != null && variant.annots.consequenceTypes.length > 0) {

                    var sif = -1;
                    var sifDesc = "";
                    var poly = -1;
                    var polyDesc = "";

                    for (var j = 0, l = variant.annots.consequenceTypes.length; j < l; j++) {
                        var ct = variant.annots.consequenceTypes[j];

                        if (ct.proteinSubstitutionScores != null && ct.proteinSubstitutionScores.length > 0) {
                            var auxSift = null;
                            var auxPoly = null;
                            for (var k = 0, l = ct.proteinSubstitutionScores.length; k < l; k++) {

                                var pss = ct.proteinSubstitutionScores[k];
                                switch (pss.source) {
                                    case 'sift':
                                        auxSift = pss;
                                        break;
                                    case 'polyphen':
                                        auxPoly = pss;
                                        break;
                                }
                            }

                            if (auxPoly != null && auxSift != null) {
                                if (auxPoly.score > poly) {
                                    sif = auxSift.score;
                                    poly = auxPoly.score;

                                    sifDesc = auxSift.description;
                                    polyDesc = auxPoly.description;
                                }
                            }
                        }
                    }
                    if (sif != -1 && poly != -1) {

                        if (sifDesc) {
                            variant.sift = sif + " (" + sifDesc + ")";
                        } else {
                            variant.sift = sif;
                        }

                        if (polyDesc) {
                            variant.polyphen = poly + " (" + polyDesc + ")";
                        } else {
                            variant.polyphen = poly;
                        }
                    }
                }

                // Clinical
                variant.phenotypes = {cosmic: "", gwas: "", clinvar: ""};

                if (variant.annots.clinical != null) {
                    var clinical = variant.annots.clinical;

                    var phenotypesCosmic = [];
                    var phenotypesGwas = [];
                    var phenotypesClinvar = [];
                    if (clinical.cosmic != null) {
                        for (var j = 0; j < clinical.cosmic.length; j++) {
                            var cosmic = clinical.cosmic[j];
                            if (cosmic.primaryHistology != null && cosmic.primaryHistology != "") {
                                phenotypesCosmic.push(cosmic.primaryHistology);
                            }
                        }
                    }

                    if (clinical.gwas != null) {
                        for (var j = 0; j < clinical.gwas.length; j++) {
                            var gwas = clinical.gwas[j];
                            for (var k = 0; k < gwas.traits.length; k++) {
                                var trait = gwas.traits[k];
                                if (trait != null && trait != "") {
                                    phenotypesGwas.push(trait);
                                }
                            }
                        }
                    }

                    if (clinical.clinvar != null) {
                        for (var j = 0; j < clinical.clinvar.length; j++) {
                            var clinvar = clinical.clinvar[j];
                            for (var k = 0; k < clinvar.traits.length; k++) {
                                var trait = clinvar.traits[k];
                                if (trait != null && trait != "") {
                                    phenotypesClinvar.push(trait);
                                }
                            }
                        }
                    }

                    var phenotypesCosmicFinal = phenotypesCosmic.filter(function (item, pos) {
                        return phenotypesCosmic.indexOf(item) == pos;
                    });
                    var phenotypesGwasFinal = phenotypesGwas.filter(function (item, pos) {
                        return phenotypesGwas.indexOf(item) == pos;
                    })
                    var phenotypesClinvarFinal = phenotypesClinvar.filter(function (item, pos) {
                        return phenotypesClinvar.indexOf(item) == pos;
                    })


                    variant.phenotypes = {
                        cosmic: phenotypesCosmicFinal.join(","),
                        gwas: phenotypesGwasFinal.join(","),
                        clinvar: phenotypesClinvarFinal.join(",")
                    };
                }

                if (variant.annots.populationFrequencies != null) {

                    for (var j = 0; j < variant.annots.populationFrequencies.length; j++) {

                        var pfreq = variant.annots.populationFrequencies[j];

                        if (pfreq.study === "1000GENOMES_phase_1") {
                            switch (pfreq.pop) {
                                case "ALL":
                                    var maf = Math.min(pfreq.refAlleleFreq, pfreq.altAlleleFreq);
                                    variant.maf1000G = Number(maf).toFixed(3)
                                    break;

                                case "AMR":
                                    var maf = Math.min(pfreq.refAlleleFreq, pfreq.altAlleleFreq);
                                    variant.maf1000GAME = Number(maf).toFixed(3)
                                    break;

                                case "ASN":
                                    var maf = Math.min(pfreq.refAlleleFreq, pfreq.altAlleleFreq);
                                    variant.maf1000GASI = Number(maf).toFixed(3)
                                    break;

                                case "AFR":
                                    var maf = Math.min(pfreq.refAlleleFreq, pfreq.altAlleleFreq);
                                    variant.maf1000GAFR = Number(maf).toFixed(3)
                                    break;

                                case "EUR":
                                    var maf = Math.min(pfreq.refAlleleFreq, pfreq.altAlleleFreq);
                                    variant.maf1000GEUR = Number(maf).toFixed(3)
                                    break;
                            }
                        }
                        else if (pfreq.study === "1000G_PHASE_3") {
                            switch (pfreq.pop) {
                                case "1000G_PHASE_3_ALL":
                                    var maf = Math.min(pfreq.refAlleleFreq, pfreq.altAlleleFreq);
                                    variant.maf1000G_PHASE_3_ALL = Number(maf).toFixed(3)
                                    break;
                                case "1000G_PHASE_3_SAS":
                                    var maf = Math.min(pfreq.refAlleleFreq, pfreq.altAlleleFreq);
                                    variant.maf1000G_PHASE_3_SAS = Number(maf).toFixed(3)
                                    break;
                                case "1000G_PHASE_3_EAS":
                                    var maf = Math.min(pfreq.refAlleleFreq, pfreq.altAlleleFreq);
                                    variant.maf1000G_PHASE_3_EAS = Number(maf).toFixed(3)
                                    break;
                                case "1000G_PHASE_3_AMR":
                                    var maf = Math.min(pfreq.refAlleleFreq, pfreq.altAlleleFreq);
                                    variant.maf1000G_PHASE_3_AMR = Number(maf).toFixed(3)
                                    break;
                                case "1000G_PHASE_3_AFR":
                                    var maf = Math.min(pfreq.refAlleleFreq, pfreq.altAlleleFreq);
                                    variant.maf1000G_PHASE_3_AFR = Number(maf).toFixed(3)
                                    break;
                                case "1000G_PHASE_3_EUR":
                                    var maf = Math.min(pfreq.refAlleleFreq, pfreq.altAlleleFreq);
                                    variant.maf1000G_PHASE_3_EUR = Number(maf).toFixed(3)
                                    break;

                            }
                        }
                        else if (pfreq.study === "ESP_6500") {
                            switch (pfreq.pop) {
                                case "European_American":
                                    var maf = Math.min(pfreq.refAlleleFreq, pfreq.altAlleleFreq);
                                    variant.mafESP_EA = Number(maf).toFixed(3)
                                    break;

                                case "African_American":
                                    var maf = Math.min(pfreq.refAlleleFreq, pfreq.altAlleleFreq);
                                    variant.mafESP_AA = Number(maf).toFixed(3)
                                    break;


                            }
                        }
                    }
                }
            }
            return data;
        },
        _parseTotal: function (response) {
            return response.numTotalResults;
        },
        handleRowClick: function (e) {
            var row = e.detail.row;

            this.$.gv.genomeViewer.setRegion(row);
            this.$.effect.row = row;
            this.$.frequency.row = row;
            this.$.phenotype.row = row;

        },
        handleMenuClick: function (e) {
            this.selectedMenuTool = e.currentTarget;
        },
        selectedMenuChanged: function (neo, old) {
            if (old) {
                old.removeAttribute('selected');
                this.$[old.dataset.option].setAttribute('hidden', '');
            }
            if (neo && !this.hidden) {
                neo.setAttribute('selected', '');
                this.$[neo.dataset.option].removeAttribute('hidden');
            }
        }
    });
</script>
