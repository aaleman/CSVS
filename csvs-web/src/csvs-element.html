<script src="../bower_components/cookies-js/dist/cookies.min.js"></script>
<script src="../bower_components/crypto-js-evanvosberg/core.js"></script>
<script src="../bower_components/crypto-js-evanvosberg/sha1.js"></script>
<script src="../bower_components/highcharts-release/adapters/standalone-framework.js"></script>
<script src="../bower_components/highcharts-release/highcharts.js"></script>
<script src="../bower_components/highcharts-release/highcharts-more.js"></script>
<script src="../bower_components/highcharts-release/modules/exporting.js"></script>

<script src="../bower_components/jquery/dist/jquery.min.js"></script>
<script src="../bower_components/underscore/underscore-min.js"></script>
<script src="../bower_components/backbone/backbone.js"></script>
<script src="../bower_components/qtip2/jquery.qtip.min.js"></script>
<script src="../bower_components/pako/dist/pako.min.js"></script>
<script src="../bower_components/uri.js/src/URI.min.js"></script>

<link rel="stylesheet" href="../bower_components/qtip2/jquery.qtip.css">


<link rel="import" href="../lib/stevia-components/src/stv-header.html">
<link rel="import" href="../lib/stevia-components/src/stv-application-behavior.html">
<link rel="import" href="../lib/stevia-components/src/stv-footer.html">
<link rel="import" href="../lib/stevia-components/src/stv-help-menu.html">
<link rel="import" href="../lib/stevia-components/src/stv-select.html">

<link rel="import" href="../lib/stevia-components/src/stv-panel.html">
<link rel="import" href="../lib/stevia-components/src/table/stv-table.html">
<link rel="import" href="../lib/stevia-components/src/validator/stv-validator.html">
<link rel="import" href="../lib/stevia-components/src/job/stv-job-browser.html">
<link rel="import" href="../lib/stevia-components/src/file/stv-file-browser.html">

<script src="../lib/jsorolla/src/lib/validator/bed-validator.js"></script>
<script src="FilterHistory.js"></script>


<!-- <link rel="import" href="../lib/jsorolla/src/lib/components/jso-application-behavior.html"> -->
<!-- <link rel="import" href="../lib/jsorolla/src/lib/components/opencga/jso-opencga-manager-behavior.html"> -->

<!-- <link rel="import" href="../lib/jsorolla/src/lib/components/jso-panel.html"> -->
<!-- <link rel="import" href="../lib/jsorolla/src/lib/components/jso-select.html"> -->
<!-- <link rel="import" href="../lib/jsorolla/src/lib/components/table/jso-table.html"> -->
<!-- <link rel="import" href="../lib/jsorolla/src/lib/validator/jso-validator.html"> -->
<!-- <link rel="import" href="../lib/jsorolla/src/lib/components/jso-help-menu.html"> -->

<!-- <link rel="import" href="../lib/jsorolla/src/lib/components/opencga/jso-opencga-header.html"> -->
<!-- <link rel="import" href="../lib/jsorolla/src/lib/components/opencga/jso-opencga-footer.html"> -->
<!-- <link rel="import" href="../lib/jsorolla/src/lib/components/opencga/files/jso-opencga-job-browser.html"> -->
<!-- <link rel="import" href="../lib/jsorolla/src/lib/components/opencga/samples/jso-opencga-sample-browser.html"> -->
<!-- <link rel="import" href="../lib/jsorolla/src/lib/components/opencga/files/jso-opencga-upload-file.html"> -->
<!-- <link rel="import" href="../lib/jsorolla/src/lib/components/opencga/files/jso-opencga-create-study.html"> -->
<!-- <link rel="import" href="../lib/jsorolla/src/lib/components/opencga/files/jso-opencga-create-project.html"> -->
<!-- <link rel="import" href="../lib/jsorolla/src/lib/components/opencga/files/jso-opencga-browser.html"> -->


<link rel="import" href="csvs-content.html">
<link rel="import" href="csvs-menubar.html">
<link rel="import" href="csvs-home.html">
<link rel="import" href="csvs-search-element.html">
<link rel="import" href="csvs-stats-element.html">
<link rel="import" href="csvs-annotation-form.html">
<link rel="import" href="csvs-annotation-result.html">


<dom-module id="csvs-element">
    <style>
        :host {
            display: block;
            position: relative;
            cursor: default;
            font-size: 13px;
            height: 100%;
            background-color: var(--default-primary-color);
        }

        .content {
            position: absolute;
            width: 100%;
            top: 60px;
        }

        @media (max-width: 1100px) {
            .option-text {
                display: none;
            }
        }

        stv-header {
            position: absolute;
            top: 0;
        }

        stv-footer {
            position: absolute;
            bottom: 0;
        }

        csvs-search-element {
            height: calc(100vh - 60px);
        }

        /*#stvBrowserPanel {
            position: absolute;
            right: 0;
            top: 0;
            width: 600px;
        }

        #browserPanel {
            position: absolute;
            left: 0;
            top: 0;
            width: 600px;
        }*/

        #jobBrowserPanel {
            position: absolute;
            top: 0px;
            right: 0;
            width: 600px;
            height: 400px;
            min-width: 600px;
            min-height: 400px;
        }

        #fileBrowserPanel {
            position: absolute;
            top: 0px;
            left: 0;
            width: 600px;
            height: 400px;
            min-width: 600px;
            min-height: 400px;
        }
    </style>
    <template>

        <div class="content" menu-option="home">
            <csvs-home on-try="handleTry"></csvs-home>
        </div>

        <div class="content" menu-option="search">
            <csvs-search-element diseases="{{diseases}}"
                                 technologies="{{technologies}}"
                                 id="csvsSearchElement"
                                 is-logged="{{isLogged}}"></csvs-search-element>
        </div>

        <div class="content" menu-option="stats">
            <csvs-stats-element diseases="{{diseases}}" id="csvsStatsElement"></csvs-stats-element>
        </div>

        <div class="content" menu-option="annot">
            <csvs-annotation-form id="annotationForm" selectedOption="{{selectedOption}}" bioformats="{{bioformats}}"
                                  user-data="{{userData}}" diseases="{{diseases}}"
                                  on-job-launched="handleJobLaunched"></csvs-annotation-form>
        </div>

        <div class="content" menu-option="result">
            <csvs-annotation-result id="annotationResult"></csvs-annotation-result>
        </div>


        <div class="content" menu-option="home,search,stats,annot,result">
            <stv-panel hidden collapsible closable movable id="fileBrowserPanel" on-hidden="handlePanelHidden">
                <div class="header">
                    <i class="fa fa-folder-open-o"></i> File Browser
                </div>
                <stv-file-browser class="container" id="browser" bioformats="{{bioformats}}"
                                  user-data="{{userData}}"></stv-file-browser>
            </stv-panel>

            <stv-panel hidden collapsible movable closable id="jobBrowserPanel" on-hidden="handlePanelHidden">
                <div class="header">Job browser</div>
                <stv-job-browser class="container" id="jobBrowser" on-jobselect="handleJobSelect"
                                 bioformats="{{bioformats}}" allowed-tools="{{allowedTools}}" user-data="{{userData}}"
                                 on-job-launched="handleJobLaunched"></stv-job-browser>
            </stv-panel>
        </div>

        <stv-header id="stvHeader" user-data="{{userData}}" on-login="handleLogin" on-logout="handleLogout"
                    selected-option="{{selectedOption}}" hide-browse>
            <div class="icon">
                <img src="images/bier-text.svg" style="height: 50px;margin: 5px 0px 0 0;">
            </div>
            <span class="title">CIBERER Spanish Variant Server</span>
            <span class="description"></span>

            <div id="menu" class="menu horizontal layout flex">
                <div title="Search" class="option" on-click="handleMenuOption" data-option="search">
                    <i class="fa fa-search"></i>
                    <span class="option-text">Search</span>
                </div>

                <div title="Stats" class="option" on-click="handleMenuOption" data-option="stats">
                    <i class="fa fa-pie-chart"></i>
                    <span class="option-text">Stats</span>
                </div>
                <div title="Annotate VCF file" class="option" on-click="handleLoggedOnlyMenuOption" show-on-login
                     data-option="annot">
                    <i class="fa fa-pencil-square-o"></i>
                    <span class="option-text">Annotate VCF File</span>
                </div>
                <div class="flex"></div>
                <div title="Browse my data" class="option" on-click="handleLoggedOnlyMenuPanel" show-on-login
                     data-panel="fileBrowserPanel">
                    <i class="fa fa-folder-open-o"></i>
                    <span class="option-text">My data</span>
                </div>
                <div title="Show diagnoses" class="option" on-click="handleLoggedOnlyMenuPanel" show-on-login
                     data-panel="jobBrowserPanel">
                    <i class="fa fa-pencil-square-o"></i>
                    <span class="option-text">My annotations</span>
                </div>
            </div>

            <stv-help-menu class="helpmenu" selectedOption="{{selectedOption}}">
                <a href="https://github.com/babelomics/csvs/wiki" target="_blank">
                    <i class="fa fa-book"></i> &nbsp; Documentation
                </a>
                <a href="https://github.com/babelomics/csvs/wiki/tutorial" target="_blank">
                    <i class="fa fa-compass"></i> &nbsp; Tutorial
                </a>
                <a href="https://github.com/babelomics/csvs/" target="_blank">
                    <i class="fa fa-github"></i> &nbsp; Source code
                </a>
            </stv-help-menu>
        </stv-header>

        <stv-footer menu-option="home,login,singup,profile,remember">
            CSVS: created by Computational Genomics Department
            <br> Principe Felipe Research Center
            <br> 2015
        </stv-footer>
    </template>
</dom-module>
<script>
    Polymer({
        is: 'csvs-element',
        // behaviors: [JsoApplicationBehavior, JsoOpencgaManagerBehavior],
        behaviors: [StvApplicationBehavior],
        properties: {
            diseases: {
                type: Array,
                value: function () {
                    return [];
                }
            },
            technologies: {
                type: Array,
                value: function () {
                    return [];
                }
            },
            bioformats: {
                type: Array,
                value: [{
                    text: "VCF 4.0",
                    value: "VARIANT",
                    validator: VCFValidator
                }]
            },
            allowedTools: {
                type: Array,
                value: function () {
                    return ["csvs"];
                }
            },
            isLogged: {
                type: Boolean
            }
        },
        ready: function () {
            this.isLogged = this.$.stvHeader.isLogged;
            this.getDiseases();
            this.getTechnologies();
            this.checkShowMenuOnLogin();
            this.selectedOption = "search";
        },
        getDiseases: function () {
            var me = this;
            CSVSManager.diseases.list({
                request: {
                    async: false,
                    success: function (response) {
                        try {
                            var diseases = [];

                            var ibsPos = -1;
                            var mgpPos = -1;

                            for (var i = 0; i < response.result.length; i++) {
                                var elem = response.result[i];
                                if (elem.name === "IBS (107 Spanish individuals from 1000genomes)") {
                                    ibsPos = i;
                                } else if (elem.name === "MGP (267 healthy controls)") {
                                    mgpPos = i;
                                } else {
                                    diseases.push(elem);
                                }
                            }
                            if (ibsPos != -1) {
                                diseases.unshift(response.result[ibsPos]);
                            }
                            if (mgpPos != -1) {
                                diseases.unshift(response.result[mgpPos]);
                            }
                            me.diseases = diseases;
                        } catch (err) {
                            console.log("Error loading diseases: " + err);
                            me.diseases = [];
                        }
                    },
                    error: function (response) {
                        console.log("ERROR downloading diseases");
                        console.log(response);
                    }
                }
            });

        },
        getTechnologies: function () {
            var me = this;
            CSVSManager.technologies.list({
                request: {
                    async: false,
                    success: function (response) {
                        try {
                            var technologies = [];


                            for (var i = 0; i < response.result.length; i++) {
                                var elem = response.result[i];
                                technologies.push(elem);
                            }

                            me.technologies = technologies;
                        } catch (err) {
                            console.log("Error loading technologies: " + err);
                            me.technologies = [];
                        }
                    },
                    error: function (response) {
                        console.log("ERROR downloading technologies");
                        console.log(response);
                    }
                }
            });

        },
        _swap: function (array, x, y) {
            var b = array[y];
            array[y] = array[x];
            array[x] = b;
        },
        handleTry: function () {
            this.setMenu("search");
        },
        handleLogin: function () {
            // this.selectedOption = "panels";
            // this.homeHidden =
            this.isLogged = this.$.stvHeader.isLogged;
            this.checkShowMenuOnLogin();
        },
        handleLogout: function () {
            this.isLogged = this.$.stvHeader.isLogged;
            this.checkShowMenuOnLogin()
            this.setMenu("home");
            this.$.fileBrowserPanel.hide();
            this.$.jobBrowserPanel.hide();
        },
        handleJobSelect: function (e) {
            var me = this;

            var job = e.detail;
            var fileId = job.folder._id;
            var fileName = job.options.outfile.value;
            // var dir = job.outDirId;
            // var file = null;


            SteviaManager.getPlainFolderFiles(fileId, function (files) {
                // debugger
                for (var i = 0; i < files.length; i++) {
                    if (files[i].name == fileName)
                        me.$.annotationResult.file = files[i];
                }
                me.setMenu("result");
                // me.$.annotationResult.file = job.options.input.value;
            })
        },
        handleJobLaunched: function (e) {
            this.$.jobBrowserPanel.show();
            this.handleUserNeedRefresh();
        },
        handleUserNeedRefresh: function () {
            // console.log("funsiona");
            this.$.stvHeader.getUserInfo(true);
        },
    });
</script>
