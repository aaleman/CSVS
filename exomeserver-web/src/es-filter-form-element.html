<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/polymer-fontawesome/polymer-fontawesome.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/core-list/core-list.html">

<polymer-element name="es-filter-form-element" attributes="studies formURL">
    <template>
        <link rel="stylesheet" href="../lib/jsorolla/src/lib/components/jso-style.css">
        <style>
            :host {
                display: block;
                box-sizing: border-box;
                position: relative;
                background-color: #FFFFFF;

                margin: 20px;
            }

            paper-button {
                margin: 10px;
            }

            label:after {
                content: ':';
            }

            .input_container {
                margin: 0px;
                width: 175px;
                right: auto;
                top: 0px;
                /*left: 5px;*/
                padding: 4px 6px 3px 6px;
            }

            .input_container input {
                min-height: 50px;
            }

            .input_container label {
                padding-bottom: 5px;
                padding-left: 1px;
            }

            #headerTitle {
                background: #e4e7e9;
                color: #435F7A;
                font-size: 16px;
                line-height: 22px;

                margin: 10px;
                padding: 5px;
            }

            .position_filter {
                width: 200px;
            }

            .sdp_block {
                width: 300px;
                height: 200px;
                border-style: solid;
                border-width: 1px;
                margin-right: 10px;
            }

            .row {
                height: 20px;
            }

            core-list {
                height: 150px;
            }

            .filter_box {
                margin-top: 5px;
            }

        </style>

        <form id="filter_form" vertical layout>
            <div horizontal layout>
                <div class="position_filter">
                    <div id="headerTitle">Position</div>

                    <div class="input_container" vertical layout>
                        <label class="input_label">SNP id</label>
                        <input id="snp" name="snp" type="text"/>
                    </div>

                    <div class="input_container" vertical layout>
                        <label class="input_label">Chromosomal Location</label>

                        <input id="region" name="region" type="text" placeholder="1:1-1000000,2:1-1000000"
                               value="{{ regionValue }}"/>
                    </div>

                    <div class="input_container" vertical layout>
                        <label class="input_label">Gene / Transcript</label>
                        <input id="gene" name="gene" type="text"/>
                    </div>
                </div>
                <div flex>
                    <div id="headerTitle">Studies</div>
                    <div horizontal layout>
                        <div class="sdp_block" id="studies_div">

                            <core-list data="{{ studyNames }}" height="20px">
                                <template>
                                    <div class="row">
                                        <input type="checkbox" name="study" value="{{ model.name }}"
                                               on-click="{{ studyClick }}"/>{{
                                        model.name }}
                                    </div>
                                </template>
                            </core-list>
                            <div class="filter_box">
                                <input type="text" on-keyup="{{ studyKeyUp }}" placeholder="Filter:"/>
                            </div>


                        </div>
                        <div class="sdp_block" id="diseases_div">
                            <core-list data="{{ diseases }}" height="20px">
                                <template>
                                    <div class="row">
                                        <input type="checkbox" name="disease" value="{{ model.name }}"
                                               on-click="{{ diseaseClick }}"/>{{
                                        model.name }}
                                    </div>
                                </template>
                            </core-list>
                            <div class="filter_box">
                                <input type="text" on-keyup="{{ diseaseKeyUp }}" placeholder="Filter:"/>
                            </div>
                        </div>
                        <div class="sdp_block" id="phenotypes_div">
                            <core-list data="{{ phenotype }}" height="20px">
                                <template>
                                    <div class="row">
                                        <input type="checkbox" name="phenotype" value="{{ model.name }}"
                                               on-click="{{ phenotypeClick }}"/>{{
                                        model.name }}
                                    </div>
                                </template>
                            </core-list>
                            <div class="filter_box">
                                <input type="text" on-keyup="{{ phenotypeKeyUp }}" placeholder="Filter:"/>
                            </div>
                        </div>
                        <div class="sdp_block" id="log_div">
                            <core-list data="{{ log }}" height="20px">
                                <template>
                                    <div class="row">{{ model.log }}</div>
                                </template>
                            </core-list>
                        </div>

                    </div>
                </div>

            </div>
            <div id="buttons_container" horizontal layout>
                <paper-button raised>Clear</paper-button>
                <paper-button raised on-click="{{ submitForm }}">Submit</paper-button>
            </div>
        </form>
    </template>
    <script>
        Polymer({
            regionValue: '1:1-100000',
            created: function () {

                this.studies = [];
                this.studyNames = [];
                this.diseases = [];
                this.phenotype = [];
                this.log = [];

                this.formStudies = {};
                this.formDiseases = {};
                this.formPhenotypes = {};


            },
            ready: function () {
            },
            submitForm: function () {


                var me = this;
                var auxStudies = [];
                var auxDiseases = [];
                var auxPhenotypes = [];
                var query = {};

                Object.keys(this.formStudies).forEach(function (key) {
                    var value = me.formStudies[key];
                    if (value) {
                        auxStudies.push(key);
                    }
                });

                Object.keys(this.formDiseases).forEach(function (key) {
                    var value = me.formDiseases[key];
                    if (value) {
                        auxDiseases.push(key);
                    }
                });

                Object.keys(this.formPhenotypes).forEach(function (key) {
                    var value = me.formPhenotypes[key];
                    if (value) {
                        auxPhenotypes.push(key);
                    }
                });


                if (auxStudies.length > 0) {
                    query.studies = auxStudies.join(",");
                }
                if (auxDiseases.length > 0) {
                    query.diseases = auxDiseases.join(",");
                }

                if (auxPhenotypes.length > 0) {
                    query.phenotypes = auxPhenotypes.join(",");
                }

                var url = ExomeServerManager.variants.fetch({
                    id: this.regionValue,
                    query: query,
                    request: {
                        url: true
                    }
                });
                this.formURL = url;

            },
            regionValueChanged: function (oldValue, newValue) {
                console.log(newValue);
            },
            studiesChanged: function (oldValue, newValue) {
                var me = this;
                this.studies = newValue;
                var names = {};
                var dis = {};
                var phen = {};
                for (var i = 0; i < this.studies.length; i++) {
                    var study = this.studies[i];

                    names[study.sname] = study.sname;
                    dis[study.meta.dis] = study.meta.dis;
                    phen[study.meta.phe] = study.meta.phe;

                }
                Object.keys(names).forEach(function (key) {
                    me.studyNames.push({
                        name: key
                    })
                });
                Object.keys(dis).forEach(function (key) {
                    me.diseases.push({
                        name: key
                    })
                });

                Object.keys(phen).forEach(function (key) {
                    me.phenotype.push({
                        name: key
                    })
                });

            },
            studyClick: function (event, detail, sender) {

                this.formStudies[sender.value] = sender.checked;

            },
            diseaseClick: function (event, detail, sender) {

                this.formDiseases[sender.value] = sender.checked;

            },
            phenotypeClick: function (event, detail, sender) {

                this.formPhenotypes[sender.value] = sender.checked;

            },
            studyKeyUp: function (event, detail, sender) {
                var reg = new RegExp(sender.value, "i");
                var snames = [];
                var names = {};

                for (var i = 0; i < this.studies.length; i++) {
                    var study = this.studies[i];
                    if (reg.test(study.sname)) {
                        names[study.sname] = study.sname;
                    }
                }
                Object.keys(names).forEach(function (key) {
                    snames.push({
                        name: key
                    })
                });

                this.studyNames = snames;

            },
            diseaseKeyUp: function (event, detail, sender) {
                var reg = new RegExp(sender.value, "i");
                var snames = [];
                var names = {};

                for (var i = 0; i < this.studies.length; i++) {
                    var study = this.studies[i];
                    if (reg.test(study.meta.dis)) {
                        names[study.meta.dis] = study.meta.dis;

                    }
                }
                Object.keys(names).forEach(function (key) {
                    snames.push({
                        name: key
                    })
                });

                this.diseases = snames;

            }
            , phenotypeKeyUp: function (event, detail, sender) {
                var reg = new RegExp(sender.value, "i");
                var snames = [];
                var names = {};

                for (var i = 0; i < this.studies.length; i++) {
                    var study = this.studies[i];
                    if (reg.test(study.meta.phe)) {
                        names[study.meta.phe] = study.meta.phe;

                    }
                }
                Object.keys(names).forEach(function (key) {
                    snames.push({
                        name: key
                    })
                });

                this.phenotype = snames;

            }


        });
    </script>
</polymer-element>
