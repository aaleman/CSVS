<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/polymer-fontawesome/polymer-fontawesome.html">
<link rel="import" href="../bower_components/sortable-table/sortable-table.html">
<link rel="import" href="../bower_components/core-collapse/core-collapse.html">
<link rel="import" href="opencb-ajax.html">


<polymer-element name="es-data-grid-element" attributes="formURL studies">
    <template>
        <link rel="stylesheet" href="../lib/jsorolla/styles/css/style.css">
        <link rel="stylesheet" href="../lib/jsorolla/src/lib/components/jso-style.css">
        <link rel="stylesheet" href="../lib/jsorolla/src/lib/components/jso-panel.css">
        <link rel="stylesheet" href="../lib/jsorolla/src/lib/components/sortable-table.css">
        <link rel="stylesheet" href="../lib/jsorolla/vendor/font-awesome/css/font-awesome.min.css">

        <link rel="stylesheet" href="../bower_components/sortable-table/css/bootstrap.css" shim-shadowdom>

        <style>
            :host {
                display: block;
                box-sizing: border-box;
                position: relative;
                background-color: #FFFFFF;

            }

            sortable-table {
                height: 340px;
                /*max-width: 100%;*/
                border: 1px solid #d3d3d3;
                overflow-x: auto;
            }

            .defaultPager > input {
                width: 40px;
            }

            .bootstrap::shadow > table > tfoot > tr > td > .defaultPager > span > input::-webkit-inner-spin-button {
                -webkit-appearance: none;
                margin: 0;
            }

            .bootstrap::shadow > table > tfoot > tr > td > .defaultPager {
                max-height: 15px;
            }

            .bootstrap::shadow .btn-sm {
                padding: 1px 4px;
            }

            .bootstrap::shadow > table > tbody > tr > td {
                padding: 3px;
            }

            #panel {
                background-color: #FFF;
                overflow-y: auto;
            }

            .headerexpand:after {
                font-family: FontAwesome;
                content: '\f065';
            }

            .headerexpand[expanded]:after {
                content: '\f066';
            }

            .container > span {
                margin-left: 10px;
            }

            #genomeViewer {
                transition: height 0.15s;
            }

        </style>

        <div class="panel panel-shadow">
            <div class="headerTitle" id="header" horizontal layout end-justified>
                <div class="text headerexpand" expanded?={{expanded}} on-click="{{handleExpand}}"></div>
            </div>
            <core-collapse id="collapseGrid" opened>
                <sortable-table class="bootstrap"
                                id="dataGrid"
                                footerTemplate="defaultPager"
                                pageSize="10"
                                columns="{{ columns }}"
                                loading="true"
                                rowSelection="true">
                    <opencb-ajax id="opencbAjax"
                                 role="datasource"
                                 url="{{ formURL }}"
                                 start=0
                                 length=10
                    </opencb-ajax>
                </sortable-table>
            </core-collapse>
            <div id="genomeViewer" flex></div>
        </div>
    </template>
    <script>


        Polymer({
            floatDecimals: 3,
            expanded: true,
            created: function () {

                var me = this;

                this.selectedSpecies = DEFAULT_SPECIES;
                this.region = new Region();
//                this.region.load(this.selectedSpecies.region);
                this.region.load("1:1004608-1004608");

                this.variants = [];
                this.columns = [
                    {name: 'chromosome', title: 'Chr'},
                    {name: 'start', title: 'Position'},
                    {
                        name: 'alleles',
                        title: 'Alleles',
                        formula: function (row) {
                            return row.reference + ">" + row.alternate;
                        }
                    },
                    {name: 'id', title: 'Id'},
                    {
                        name: 'files_maf_0_0', title: 'Count: 0/0',
                        formula: function (row) {

                            var aux = row.sourceEntries.MAF.stats.genotypesCount["0/0"];
                            if ("0|0" in row.sourceEntries.MAF.stats.genotypesCount) {
                                if (aux != null) {
                                    aux += row.sourceEntries.MAF.stats.genotypesCount["0|0"];
                                } else {
                                    aux = row.sourceEntries.MAF.stats.genotypesCount["0|0"];
                                }
                            }
                            return aux;
                        }
                    },
                    {
                        name: 'files_maf_0_1', title: 'Count: 0/1',
                        formula: function (row) {
                            var aux = row.sourceEntries.MAF.stats.genotypesCount["0/1"];
                            if ("0|1" in row.sourceEntries.MAF.stats.genotypesCount) {
                                if (aux != null) {
                                    aux += row.sourceEntries.MAF.stats.genotypesCount["0|1"];
                                } else {
                                    aux = row.sourceEntries.MAF.stats.genotypesCount["0|1"];
                                }
                            }
                            return aux;
                        }
                    },
                    {
                        name: 'files_maf_1_1', title: 'Count: 1/1',
                        formula: function (row) {
                            var aux = row.sourceEntries.MAF.stats.genotypesCount["1/1"];
                            if ("1|1" in row.sourceEntries.MAF.stats.genotypesCount) {
                                if (aux != null) {
                                    aux += row.sourceEntries.MAF.stats.genotypesCount["1|1"];
                                } else {
                                    aux = row.sourceEntries.MAF.stats.genotypesCount["1|1"];
                                }
                            }
                            return aux;
                        }
                    },
                    {
                        name: 'freqRef', title: "Ref. Freq",
                        formula: function (row) {
                            var genotypes = row.sourceEntries.MAF.stats.genotypesCount;

                            var count = 0;
                            var total = 0;

                            Object.keys(genotypes).forEach(function (key) {
                                var value = genotypes[key];
                                var splits = key.split(/[/|]/);
                                for (var i = 0; i < splits.length; i++) {
                                    var g = splits[i];
                                    if (g == "0") {
                                        count += value;
                                    }
                                    total += value;
                                }
                            });


                            maf = count / total;

                            return maf.toFixed(me.floatDecimals);
                        }
                    },
                    {
                        name: 'freqAlt', title: "Alt. Freq",
                        formula: function (row) {
                            var genotypes = row.sourceEntries.MAF.stats.genotypesCount;

                            var count = 0;
                            var total = 0;

                            Object.keys(genotypes).forEach(function (key) {
                                var value = genotypes[key];
                                var splits = key.split(/[/|]/);
                                for (var i = 0; i < splits.length; i++) {
                                    var g = splits[i];
                                    if (g == "1") {
                                        count += value;
                                    }
                                    total += value;
                                }
                            });


                            maf = count / total;

                            return maf.toFixed(3);
                        }
                    },
                    {
                        name: 'maf', title: 'MAF',
                        formula: function (row) {
                            var genotypes = row.sourceEntries.MAF.stats.genotypesCount;

                            var count = {};
                            var total = 0;
                            var maf = 1;
                            var mafAllele = -1;

                            Object.keys(genotypes).forEach(function (key) {
                                var value = genotypes[key];
                                var splits = key.split(/[/|]/);
                                for (var i = 0; i < splits.length; i++) {
                                    var g = splits[i];
                                    if (!(g in count)) {
                                        count[g] = 0;
                                    }
                                    count[g] += value;
                                    total += value;
                                }
                            });

                            Object.keys(count).forEach(function (key) {
                                var value = count[key];

                                var auxMaf = value / total;
                                if (auxMaf < maf) {
                                    maf = auxMaf;
                                    mafAllele = key;
                                }
                            });
                            return maf.toFixed(3);
                        }
                    },
                    {name: 'sift', title: 'SIFT'},
                    {name: 'polyphen', title: 'POLYPHEN'},
                    {name: 'phenotype', title: 'Phenotype'},
                ];
            },
            ready: function () {
            },
            domReady: function () {
                this.createGenomeViewer();
                this.genomeViewer.draw();
            },
            observe: {
                '$.dataGrid.selected': "handleDataGridSelected",
                '$.dataGrid.data': "handleDataGridChanged"
            },
            handleDataGridChanged: function (oldValue, newValue) {

                for (var i = 0; i < newValue.length; i++) {
                    var variant = newValue[i];
                    this._getEffect(variant);
                    this._getPolyphenSift(variant);
                }
                this._getPhenotypes(newValue);
            },
            _getEffect: function (record) {
                var req = record.chromosome + ":" + record.start + ":" + record.reference + ":" + record.alternate;
                var url = "http://ws.bioinfo.cipf.es/cellbase/rest/latest/hsa/genomic/variant/" + req + "/consequence_type?of=json";
                console.log(url);

                $.ajax({
                    url: url,
                    dataType: 'json',
                    async: false,
                    success: function (response, textStatus, jqXHR) {
                        if (response) {
                            for (var j = 0; j < response.length; j++) {
                                var elem = response[j];

                                if (elem.aaPosition != -1 && elem.transcriptId != "" && elem.aminoacidChange.length >= 3 && record.transcriptId === undefined && record.aaPos === undefined && record.aaChange === undefined) {
                                    record.transcript = elem.transcriptId;
                                    record.aaPos = elem.aaPosition;
                                    record.aaChange = elem.aminoacidChange;
                                }
                            }
                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.log('Error loading Effect');
                    }
                });
            },
            _getPolyphenSift: function (variant) {

                if (variant.aaPos != undefined && variant.aaPos >= 0) {
                    var change = variant.aaChange.split("/")[1];
                    var url = "http://ws-beta.bioinfo.cipf.es/cellbase/rest/v3/hsapiens/feature/transcript/" + variant.transcript + "/function_prediction?aaPosition=" + variant.aaPos + "&aaChange=" + change;
                    $.ajax({
                        url: url,
                        dataType: 'json',
                        async: false,
                        success: function (response, textStatus, jqXHR) {
                            var res = response.response[0];
                            if (res.numResults > 0) {
                                if (res.result[0].aaPositions[variant.aaPos]) {
                                    res = res.result[0].aaPositions[variant.aaPos][change];
                                    if (res !== undefined) {
                                        if (res.ps != null) {
                                            variant.polyphen = res.ps
                                        }
                                        if (res.ss != null) {
                                            variant.sift = res.ss;
                                        }
                                    }
                                }
                            }
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            console.log('Error loading PolyPhen/SIFT');
                        }
                    });
                }
            },
            _getPhenotypes: function (records) {
                var regs = [];
                for (var i = 0; i < records.length; i++) {
                    var variant = records[i];
                    var chr = variant.chromosome;
                    regs.push(chr + ":" + variant.start + "-" + variant.end);
                }
                if (regs.length > 0) {
                    var url = "http://ws-beta.bioinfo.cipf.es/cellbase/rest/v3/hsapiens/genomic/region/" + regs.join(",") + "/phenotype?include=phenotype";
                    $.ajax({
                        url: url,
                        dataType: 'json',
                        async: false,
                        success: function (response, textStatus, jqXHR) {
                            if (response != undefined && response.response.length > 0 && response.response.length == records.length) {
                                for (var i = 0; i < response.response.length; i++) {
                                    var elem = response.response[i];
                                    var phenotypes = [];
                                    for (var k = 0; k < elem.numResults; k++) {
                                        phenotypes.push(elem.result[k].phenotype);
                                    }
                                    records[i].phenotype = phenotypes.join(",");
                                }
                            }
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            console.log('Error loading Phenotypes');
                        }
                    });
                }
            },
            handleDataGridSelected: function (oldValue, newValue) {
                console.log(newValue);
                var reg = newValue.chromosome + ":" + newValue.start + "-" + newValue.end;
                var region = new Region(reg);
                this.genomeViewer.setRegion(region);


            },
            formURLChanged: function (oldValue, newValue) {
                this.$.dataGrid.page = 1;
            },
            studiesChanged: function (oldValue, newValue) {
                console.log("Studies GRID");
                console.log(this.studies);
                var me = this;

                var pos = 10;

                for (var i = 0; i < newValue.length; i++) {
                    var study = newValue[i];
                    this.columns.splice(pos++, 0, {
                        name: study.sname,
                        title: study.sname + " MAF",
                        formula: function (row) {

                            var maf = "";
                            try {
                                var maf = row.sourceEntries[study.sname].stats.maf;
                                maf = maf.toFixed(me.floatDecimals);

                            } catch (e) {

                            }
                            return maf;
                        }
                    });
                }
            },
            handleExpand: function () {
                this.$.collapseGrid.toggle();
                this.page = 1;
                this.expanded = !this.expanded;
            },
            createGenomeViewer: function () {
                this.genomeViewer = new GenomeViewer({
                    cellBaseHost: 'https://www.ebi.ac.uk/cellbase/webservices/rest',
                    cellBaseVersion: 'v3',
                    target: this.$.genomeViewer,
                    width: this.getBoundingClientRect().width,
                    region: this.region,
//                    version: this.version,
                    availableSpecies: AVAILABLE_SPECIES,
                    species: this.selectedSpecies,
                    sidePanel: false,
//            resizable: true,
                    resizable: false,
                    drawOverviewTrackListPanel: true,
//        quickSearchResultFn:quickSearchResultFn,
//        quickSearchDisplayKey:,
                    karyotypePanelConfig: {
                        hidden: true,
                        collapsed: false,
                        collapsible: true
                    },
                    chromosomePanelConfig: {
                        hidden: true,
                        collapsed: false,
                        collapsible: true
                    },
                    regionPanelConfig: {
                        hidden: false,
                        collapsed: false,
                        collapsible: true
                    },
                    drawStatusBar: true,
//            drawNavigationBar: false,
                    navigationBarConfig: {
                        componentsConfig: {
                            menuButton: false,
                            leftSideButton: false,
                            restoreDefaultRegionButton: false,
                            regionHistoryButton: false,
                            speciesButton: false,
                            chromosomesButton: false,
                            karyotypeButton: false,
                            chromosomeButton: false,
//                regionButton:false,
//                zoomControl:false,
//                windowSizeControl:false,
//                positionControl:false,
//                moveControl:false,
//                autoheightButton:false,
//                compactButton:false,
                            searchControl: false
                        }
                    }

//        chromosomeList:[]
//            trackListTitle: ''
//            drawNavigationBar = true;
//            drawKaryotypePanel: false,
//            drawChromosomePanel: false,
//            drawOverviewTrackListPanel: false

                });
                var renderer = new FeatureRenderer(FEATURE_TYPES.gene);
                renderer.on({
                    'feature:click': function (event) {
                        // feature click event example
                        console.log(event)
                    }
                });
                var gene = new FeatureTrack({
//        title: 'Gene overview',
                    minHistogramRegionSize: 20000000,
                    maxLabelRegionSize: 10000000,
                    height: 100,

                    renderer: renderer,

                    dataAdapter: new CellBaseAdapter({
                        category: "genomic",
                        subCategory: "region",
                        resource: "gene",
                        params: {
                            exclude: 'transcripts,chunkIds'
                        },
                        species: this.genomeViewer.species,
                        cacheConfig: {
                            defaultChunkSize: 100000
                        }
                    })
                });

                this.genomeViewer.addOverviewTrack(gene);


                this.sequence = new SequenceTrack({
                    height: 30,
                    visibleRegionSize: 200,

                    renderer: new SequenceRenderer(),

                    dataAdapter: new SequenceAdapter({
                        category: "genomic",
                        subCategory: "region",
                        resource: "sequence",
                        species: this.genomeViewer.species
                    })
                });

                this.genomeViewer.addTrack(this.sequence);

                this.gene = new GeneTrack({
                    title: 'Gene',
                    minHistogramRegionSize: 20000000,
                    maxLabelRegionSize: 10000000,
                    minTranscriptRegionSize: 200000,
                    height: 140,

                    renderer: new GeneRenderer({
                        handlers: {
                            'feature:click': function (e) {
                                console.log(e)
                            }
                        }
                    }),

                    dataAdapter: new CellBaseAdapter({
                        category: "genomic",
                        subCategory: "region",
                        resource: "gene",
                        species: this.genomeViewer.species,
                        params: {
                            exclude: 'transcripts.tfbs,transcripts.xrefs,transcripts.exons.sequence,chunkIds'
                        },
                        cacheConfig: {
                            defaultChunkSize: 100000
                        }
                    })
                });
                this.genomeViewer.addTrack(this.gene);
                this.snp = new FeatureTrack({
                    title: 'SNP',
                    featureType: 'SNP',
                    minHistogramRegionSize: 10000,
                    maxLabelRegionSize: 3000,
                    height: 100,

                    renderer: new FeatureRenderer(FEATURE_TYPES.snp),

                    dataAdapter: new CellBaseAdapter({
                        category: "genomic",
                        subCategory: "region",
                        resource: "snp",
                        params: {
                            exclude: 'transcriptVariations,xrefs,samples'
                        },
                        species: this.genomeViewer.species,
                        cacheConfig: {
                            defaultChunkSize: 10000
                        }
                    })
                });
                this.genomeViewer.addTrack(this.snp);
                return this.genomeViewer;
            }
        })
        ;
    </script>
</polymer-element>
