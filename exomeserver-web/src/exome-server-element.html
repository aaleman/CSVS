<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/polymer-fontawesome/polymer-fontawesome.html">
<link rel="import" href="../bower_components/sortable-table/sortable-table.html">
<link rel="import" href="../bower_components/core-collapse/core-collapse.html">

<link rel=" import" href="../lib/jsorolla/src/lib/components/opencga/jso-header.html">
<link rel="import" href="es-filter-form-element.html">
<link rel="import" href="es-data-grid-element.html">
<link rel="import" href="es-studies-browser-element.html">
<link rel="import" href="es-stats-element.html">

<polymer-element name="exome-server-element" attributes="urlPrefix formURL">
    <template>
        <link rel="stylesheet" href="../lib/jsorolla/src/lib/components/jso-style.css">
        <style>
            :host {
                display: block;
                position: relative;
                box-sizing: border-box;
                height: 100vh;
                background-color: #314559;

                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -khtml-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
                cursor: default;

                font-size: 13px;
            }

            #es-container {
                position: relative;
                height: calc(100vh - 60px);
                width: 100%;
            }

            [hide=true] {
                display: none !important;
            }

            [hide=false] {
                display: initial !important
            }

            es-filter-form-element {
                margin: 20px;
                border-radius: 10px;

            }

            es-data-grid-element {
                border-radius: 10px;
                padding: 5px;
            }

        </style>
        <jso-header appTitle="Exome Server" description="beta" allowLogin="false"
                    options="{{ options }}"
                    selectedOption="{{ selectedOption }}"></jso-header>

        <div id="es-container" vertical layout>
            <template if="{{ selectedOption == 'search' }}">
            <div horizontal layout center-justified>
                <es-filter-form-element studies="{{ studies }}" formURL="{{ formURL }}"
                clear="{{ clearForm }}" horizontal layout center-justified></es-filter-form-element>
            </div>
            <es-data-grid-element formURL="{{ formURL }} " studies="{{ staticStudies }}" clear="{{ clearForm }}"
                                          flex></es-data-grid-element>
            </template>

            <template if="{{ selectedOption == 'studies' }}">
                <es-studies-browser-element studies="{{ studies }}"></es-studies-browser-element>
            </template>
            <template if="{{ selectedOption == 'stats' }}">
                <es-stats-element studies="{{ studies }}"></es-stats-element>
            </template>
        </div>

    </template>
    <script>
        Polymer({
            created: function () {
                this.studies = [];
                this.staticStudies = [];
                this.options = [];
            }, ready: function () {
                this.selectedOption = 'search';
                this.clear = true;
                this.options = this.getOptions();
                this.getStudies();
            },
            getOptions: function () {
                return [
                    {
                        option: 'search',
                        text: 'Search'
                    },
                    {
                        option: 'stats',
                        text: 'Stats'

                    },
                    {
                        option: 'studies',
                        text: 'Studies Info.'

                    }
                ]
            },
            getStudies: function (event, response) {

                var me = this;

                ExomeServerManager.studies.list({
                    request: {
                        success: function (response) {

                            try {
                                var studies = [];
                                var staticStudies = [];
//                                console.log(me.studies);

                                for (var i = 0; i < response.response[0].result.length; i++) {
                                    var elem = response.response[0].result[i];
                                    if (elem.meta.sta == "false") {
                                        studies.push(elem);
                                    } else {
                                        staticStudies.push(elem);
                                    }

                                }

                                me.studies = studies;
                                me.staticStudies = staticStudies;
                            } catch (err) {
                                console.log("Error loading studies: " + err);
                                me.studies = [];
                                me.staticStudies = [];
                            }

                        },
                        error: function (response) {
                            console.log("ERROR");
                        }
                    }
                });
            },
            toggleForm: function () {
                this.$.collapse.toggle();
            }
        });
    </script>
</polymer-element>
